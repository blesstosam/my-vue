<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>

<div id="app">
  <div>state: name => {{name}} </div>
  <div>getters: plusname => {{plusname}}</div>
  <div>mutations: <button @click="changeName">commit('changeName')</button></div>
  <div>actions: <button @click="useActionToChangeName">dispatch('fetch')</button></div>
</div>

<script>
  let Vue = null

  class Store {
    constructor(opts = {}) {
      this.opts = opts

      const { state = {}, getters = {}, mutations = {}, actions = {} } = opts

      // handme state
      const _s = typeof state === 'function' ? state() : state
      this._vm = new Vue({
        data: {
          $$state: _s
        }
      })

      // handle getters
      this.getters = {}
      Object.keys(getters).forEach((k) => {
        if (typeof getters[k] === 'function') {
          const ctx = this
          Object.defineProperty(this.getters, k, {
            get() {
              const fn = getters[k]
              return fn(ctx.state)
            }
          })
        }
      })

      this.mutations = mutations

      this.actions = actions

      // todo handle modules
    }

    get state() {
      return this._vm._data.$$state
    }

    // handle mutations
    commit(name, payload) {
      const fn = this.mutations[name]
      if (fn) {
        fn(this.state, payload)
      }
    }

    // handle actions
    dispatch(name, payload) {
      const fn = this.actions[name]
      if (fn) {
        return fn(this, payload)
      }
    }
  }

  const Vuex = {
    Store,
    install(_Vue) {
      Vue = _Vue
    }
  }


  // use case
  window.Vue.use(Vuex)
  window._store = new Vuex.Store({
    state: {
      name: 'sam'
    },
    getters: {
      plusname: (state) => {
        return `blessto${state.name}`
      }
    },
    mutations: {
      changeName: (state, val) => {
        state.name = val
      }
    },
    actions: {
      fetch(context, payload) {
        return new Promise((r) => {
          setTimeout(() => {
            context.commit('changeName', payload.name)
            r()
          }, 1000)
        })
      }
    }
  })

  new Vue({
    el: '#app',
    data: {
      a: 1
    },
    computed: {
      name() {
        return _store.state.name
      },
      plusname() {
        return _store.getters.plusname
      }
    },
    methods: {
      changeName() {
        _store.commit('changeName', 'wl')
      },
      useActionToChangeName() {
        _store.dispatch('fetch', { name: 'async name' })
      }
    }
  })
</script>
